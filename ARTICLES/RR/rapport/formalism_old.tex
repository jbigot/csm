To numerically solve a set of PDEs, iterative methods (finite difference, finite volume or finite element methods) are frequently used to approximate the solution through a discretized (step by step) phenomena. Thus, the continuous time and space domains are discretized so that a set of numerical computations are iteratively (time discretization) applied onto a mesh (space discretization). In other words, the PDEs are transformed to a set of numerical computations applied at each time step on all elements of the discretized space domain. Among those numerical computations is found a set of numerical schemes, also called \textit{stencil computations}, and a set of auxiliary computations also needed to perform the simulation, and also called \emph{local computations}.

A stencil numerical expression~\cite{spaaTangCKLL11} represents the computation of an element of the mesh, at the time step $t$ and for a given data (or quantity) of the simulation, as a function of the quantities computed at $t-1$ mapped onto the same mesh element and to its neighboorhood. For example, if $A$ and $B$ are data of the simulation, if $(x,y)$ represents the Cartesian coordinates of an element of a two dimensional grid (Cartesian mesh), thus Figure~\ref{fig:ex} is an example of a stencil computation, where the neighborhood is the set of elements $(x-1,y)$, $(x,y-1)$, $(x+1,y)$ and $(x,y+1)$.

\begin{figure}[!h]\begin{center}
  \resizebox{8cm}{!}{\includegraphics{./images/example.pdf}}
  \caption{Example of a stencil computation.}
  \label{fig:ex}
\end{center}\end{figure}

Many languages and libraries exist to transparently get an optimized and parallelized code for a stencil computation~\cite{spaaTangCKLL11,citeulike12258902,Giles2011,DeVito2011LDS}. Most of those works can be considered as stencil compilers. However, a real case complex simulation is composed of more than one stencil computation and of additionnal local computations, and only a few related work handle the parallelization of an overall simulation instead of a single stencil computation. This paper presents a new approach to transparently write parallel simulations from a coarse-grain description of the numerical simulation.

In the following Section, formal definitions are given to clearly state on what we call a \textit{multi-stencil program}. Those definitions will be used in the rest of the paper.

%-------------------------------------
\subsection{Time, mesh and data}

A mesh $\mathcal{M}$ defines the discretization of the continuous space domain $\Omega$ of a set of PDEs and is defined as followed. 

\begin{mydef}
\textit{A mesh is a connected undirected graph $\mathcal{M}=(V,E)$, where $V$ is the set of vertices and $E$ the set of edges. The set of edges $E$ of a mesh $\mathcal{M}=(V,E)$ does not contain bridges.}
\end{mydef}

\begin{mydef}
$D_i$ is a set of elements of a mesh $\mathcal{M}=(V,E)$, constructed by a function $dom_i$ which defines a precise association between $V$ and $E$, $dom_i : V \times E \rightarrow D_i$. $D_i$ is called a \emph{domain} of the simulation.
\end{mydef}
For example, the set of cells $D_0$ in a Cartesian 2D mesh could be defined by exactly four vertices and four edges as a closure~\cite{}. But we could also define another set of elements $D_1$ as the simple set of vertices $V$ etc.

A mesh can be structured (as Cartesian or curvilinear meshes), unstructured, regular or irregular (without the same topology for each element) and hybrid. 

\begin{figure}[!h]\begin{center}
  \resizebox{8cm}{!}{\includegraphics{./images/maillages.pdf}}
  \caption{From left to right, Cartesian, curvilinear and unstructured meshes.}
  \label{fig:mesh}
\end{center}\end{figure}

\begin{mydef}
The discretization of the continuous time domain $\mathcal{T}$ is denoted $T$ such that $\forall\mbox{ }t_i\mbox{, }t_{i+1} \in T\mbox{, }\exists\mbox{ }\Delta t \in \mathbb{R}$\mbox{, }$t_{i+1} = t_i + \Delta t$. Thus, $T$ is responsible for the iteration time steps of the numerical simulation. 
\end{mydef}

In a numerical simulation a set of data, or quantities, are applied onto the mesh and represent the set of values to compute, or to use, for computation. A data is more precisely mapped onto a \emph{domain} of the mesh $D_i$, as follows:

\begin{mydef}
The set of data applied onto the mesh is denoted by $\Delta$, such that $\delta \in \Delta$ is a function which associates each element $d \in D_i$ (the domain it is applied on) to a value $v \in V$, $\delta : D_i \rightarrow V$. In the rest of this paper, the domain of a data $\delta \in \Delta$ can be given by the function $domain(\delta)=D_i$.
\end{mydef}
One can notice that in applied mathematics, the signature of $\delta$ would be $\delta : D_i \times T \rightarrow V$, however when programming a numerical simulation it is not wise to store all values of each time iteration.

%-----------------------
\subsection{Computations}

\begin{mydef}
A computation $c$ of a numerical simulation is defined as $c(R,w,\text{exp})$,
\end{mydef}
where $R \subset \Delta$ is the set of data read and used by the computation, $w \in \Delta$ is the data written by the computation and \textit{exp} is a numerical expression defined as follows:

\begin{mydef}
For $w \in \Delta$, and $R \subset \Delta$, a numerical expression \textit{exp} is a function which represents how to compute a value for an element $d \in domain(w)=D_i$, using the set $R \subset \Delta$ of input data (read data), $\text{exp} : R \times D_i \rightarrow w \times D_i$.
\end{mydef}

For example, the expression $B(x,y) = A(x,y)+(A(x,y+1)+A(x,y-1)+A(x+1,y)+A(x-1,y))/4$ of Figure~\ref{fig:ex} is a numerical expression, as $B(x,y) = A(x,y)$ is also one.

%It has to be noticed that at each time iteration, all the elements of a mesh are computed. However, it happens that computations of the mesh elements are splitted in different domains, as for example the computation of the physical border. In this case additional $D_i$ can be specified for the mesh $\mathcal{M}$.

\begin{mydef}
The set of $n$ ordered computations of a numerical simulation is denoted $\Gamma = [c_i]_{0 \leq i \leq n-1}$, such that $\forall c_i,c_j \in \Gamma$, if $i \leq j$, then $c_i$ is computed before $c_j$.
\end{mydef}

\begin{mydef}
A \textit{multi-stencil program} is defined by the quadruplet $\mathcal{MSP}(T,\mathcal{M},\Delta,\Gamma)$.
\end{mydef}
%If the number of computations in $\Gamma$ is $card(\Gamma)=n$, such that $\bigcup_{i=0}^{n-1}c_i = \Gamma$, then $\bigcup_{i=0}^{m-1}R_i \cup w_i \subseteq \Delta$.

As introduced before, a numerical simulation is composed of stencil and local computations. Thus, the ordered list $\Gamma$ is also composed of stencil and local computations. Those types of computations are defined in the rest of this Section.

\begin{mydef}
The neighborhood $\mathcal{N}$ of an element of a domain $d \in D_i$ is a function to obtain a set of $m$ elements in any domain $D_k \subset \mathcal{M}$, where $k$ could be equal to $i$. Thus the neighborhood is defined by the function $\mathcal{N} : D_i \rightarrow D_k^m$.
\end{mydef}
The function $\mathcal{N}$ is also sometimes called the \textit{stencil shape}, or the \textit{stencil} in applied mathematics. In this paper we distinguish a stencil shape from a \textit{stencil computation} defined as follows:

\begin{mydef}
A \textit{stencil computation} is defined as a quadruplet $s(R,w,\text{exp},\mathcal{N})$,
\end{mydef}
where $R \subset \Delta$ is the set of data read by the computation, $w : D_i \rightarrow V \in \Delta$ is the data written by the computation, \textit{exp} is the numerical expression $\text{exp} : R \times D_i \rightarrow w \times D_i$, $D_i=domain(w)$, and $\mathcal{N}$ is a neighborhood function.

In a stencil computation $s$, $\forall d \in D_i$, the stencil numerical expression $\text{exp}$ is applied such that $w(d) = \text{exp}(R(d),R(\mathcal{N}(d))$. In this work, a stencil computation $s(R,w,\text{exp},\mathcal{N})$ always verifies $R \cap \{w\} = \emptyset$, otherwize an implicit numerical scheme has to be solve which is not handled by this paper. As a result, the ordered list $\Gamma$ of a multi-stencil program can be composed of a set of stencil computations applied on one or more stencil shapes.

For example, in the example of Figure~\ref{fig:ex}, the numerical expression $B(x,y) = A(x,y)+(A(x,y+1)+A(x,y-1)+A(x+1,y)+A(x-1,y))/4$

%!!!!!!!!!!!!!!!!!!!!!!!!!

Figure~\ref{fig:ex} gives an example of a stencil computation $s(R,w,\text{exp},\mathcal{N})$, where $\mathcal{M}(V,E)$ is a two dimensional Cartesian mesh. A single domain $D=domain(w)$ is defined in this example and is composed of cells formed by a cycle of four vertices $v \in V$ and four edges $e \in E$. Furthermore, in this example $R=\{A\}$, $w=B$, and for $(x,y) \in D$ the neighborhood function is 
\begin{equation*}
\mathcal{N} : (x,y) \rightarrow \{(x,y+1),(x,y-1),(x+1,y),(x-1,y)\}.
\end{equation*}
Finally, the numerical expression of this example is 
\begin{equation*}
\text{exp}(A(x,y),A(\mathcal{N}(x,y)) = B(x,y) = A(x,y)+(A(x,y+1)+A(x,y-1)+A(x+1,y)+A(x-1,y))/4.
\end{equation*}

% \begin{figure}[!h]\begin{center}
%   \resizebox{8cm}{!}{\includegraphics{./images/example.pdf}}
%   \caption{Example of a stencil computation.}
%   \label{fig:ex}
% \end{center}\end{figure}

The second type of numerical computation is a local computation.
\begin{mydef}
A local computation is a triplet $l(R,w,\text{exp})$, where $exp$ does not involve a neighborhood function $\mathcal{N}$.
\end{mydef}

A stencil program and stencil and local computations have been formally defined in this section. This formalism is used in the next Section to define two parallelization techniques of a multi-stencil program.


